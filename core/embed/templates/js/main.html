<script>
    const modal = document.getElementById("station_info");

    function chigüiro(ev) {

        var info = {}
        modal.classList.add("active")
        const station = ev.target;
        const idStation = station.classList[0];
        const lineParent = station.parentNode;
        const reg = /linea([a-zA-Z0-9])/g;
        const line = lineParent.classList[0];
        const idLine = (line.match(reg)[0].slice(-1));
        info.idStation = idStation;
        info.idLine = idLine;
        modal.querySelector(".info").innerHTML = ``
        
        // FIXME: Change domain
        fetch(`http://embed.metromap.local:8000/request?uri=https://api.metromap.online/v1/status/${idLine}/${idStation}`)
            .then(response => response.json())
            .then(data => {
                // Guarda la respuesta en una variable
                if (data.status == "ok"){
                const stationStatus = data.data[idLine][idStation].status;
                info.stationStatus = stationStatus
                
                if (stationStatus == "O"){
                modal.querySelector(".info").innerHTML += `<a class="alert P" href="" target="_blank">
                    <svg width="649" height="573" viewBox="0 0 649 573" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M375.04 29.0626C364.587 11.1453 345.409 0.130615 324.665 0.130615C303.921 0.130615 284.744 11.1462 274.291 29.0626L8.54397 484.596C-1.98203 502.659 -2.04976 524.94 8.35648 543.049C18.7627 561.153 38.0391 572.331 58.9445 572.331H590.385C611.291 572.331 630.567 561.154 640.972 543.049C651.379 524.94 651.311 502.659 640.785 484.596L375.04 29.0626ZM324.665 420.663C340.764 420.663 353.832 433.73 353.832 449.829C353.832 465.928 340.764 478.996 324.665 478.996C308.566 478.996 295.499 465.928 295.499 449.829C295.499 433.73 308.566 420.663 324.665 420.663ZM301.332 198.996V362.329C301.332 375.21 311.785 385.663 324.665 385.663C337.546 385.663 347.999 375.21 347.999 362.329V198.996C347.999 186.116 337.546 175.663 324.665 175.663C311.785 175.663 301.332 186.116 301.332 198.996Z"
                            fill="black" />
                    </svg>
                    Operativa
                </a>`
                }
                if (stationStatus == "P"){
                modal.querySelector(".info").innerHTML += `<a class="alert P" href="" target="_blank">
                    <svg width="649" height="573" viewBox="0 0 649 573" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M375.04 29.0626C364.587 11.1453 345.409 0.130615 324.665 0.130615C303.921 0.130615 284.744 11.1462 274.291 29.0626L8.54397 484.596C-1.98203 502.659 -2.04976 524.94 8.35648 543.049C18.7627 561.153 38.0391 572.331 58.9445 572.331H590.385C611.291 572.331 630.567 561.154 640.972 543.049C651.379 524.94 651.311 502.659 640.785 484.596L375.04 29.0626ZM324.665 420.663C340.764 420.663 353.832 433.73 353.832 449.829C353.832 465.928 340.764 478.996 324.665 478.996C308.566 478.996 295.499 465.928 295.499 449.829C295.499 433.73 308.566 420.663 324.665 420.663ZM301.332 198.996V362.329C301.332 375.21 311.785 385.663 324.665 385.663C337.546 385.663 347.999 375.21 347.999 362.329V198.996C347.999 186.116 337.546 175.663 324.665 175.663C311.785 175.663 301.332 186.116 301.332 198.996Z"
                            fill="black" />
                    </svg>
                    Parcialmente Operativa
                </a>`
                }
                if (stationStatus == "M"){
                modal.querySelector(".info").innerHTML += `<a class="alert P" href="" target="_blank">
                    <svg width="649" height="573" viewBox="0 0 649 573" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M375.04 29.0626C364.587 11.1453 345.409 0.130615 324.665 0.130615C303.921 0.130615 284.744 11.1462 274.291 29.0626L8.54397 484.596C-1.98203 502.659 -2.04976 524.94 8.35648 543.049C18.7627 561.153 38.0391 572.331 58.9445 572.331H590.385C611.291 572.331 630.567 561.154 640.972 543.049C651.379 524.94 651.311 502.659 640.785 484.596L375.04 29.0626ZM324.665 420.663C340.764 420.663 353.832 433.73 353.832 449.829C353.832 465.928 340.764 478.996 324.665 478.996C308.566 478.996 295.499 465.928 295.499 449.829C295.499 433.73 308.566 420.663 324.665 420.663ZM301.332 198.996V362.329C301.332 375.21 311.785 385.663 324.665 385.663C337.546 385.663 347.999 375.21 347.999 362.329V198.996C347.999 186.116 337.546 175.663 324.665 175.663C311.785 175.663 301.332 186.116 301.332 198.996Z"
                            fill="black" />
                    </svg>
                    Mayormente Fuera de Servicio
                </a>`
                }}
            })
            .catch(error => console.error(error));

        fetch(`http://embed.metromap.local:8000/request?uri=https://api.metromap.online/v1/data/${idLine}/${idStation}`)
            .then(response => response.json())
            .then(data => {
                // Guarda la respuesta en una variable
                
                if (data.status == "ok"){
                const stationSitesOfInterest = data.data[idLine][idStation].sites_of_interest;
                const stationServices = data.data[idLine][idStation].services;
                const stationName = idStation //data.data[idLine][idStation].name;
                const lineColor = data.data[idLine]["color"];
                info.stationSitesOfInterest = stationSitesOfInterest;
                info.stationServices = stationServices;
                modal.querySelector("header .title").innerHTML = `<h3>${stationName}</h3>
                    <div class="line" style="--line-color: #${lineColor}" >${idLine}</div>
                    <button class="close">x</button>`;
                modal.querySelector("header .map").innerHTML = `<iframe width="100%" height="100%" id="gmap_canvas"
                src="https://maps.google.com/maps?q=estacion metro medellin ${stationName}&t=&z=17&ie=UTF8&iwloc=&output=embed"
                frameborder="0" scrolling="no" marginheight="0" marginwidth="0"></iframe>`;
                
                if (stationServices != "NULL"){
                    modal.querySelector(".info").innerHTML += `<div class="title">
                        <h4>Servicios</h4>
                        <span> / Services</span>
                    </div>
                    <div class="group"><div class="row"></div></div>`;
                    if (stationServices.includes("pac")){
                        modal.querySelector(".info .group").innerHTML += `<div class="row">
                        <img src="https://metromapmed.s3.amazonaws.com/assets/img/icons/pac.jpg" alt="pac">
                        <h6>Punto de Atención al Cliente</h6>
                        <span>/ Customer Service Point</span>
                        </div>`
                    }
                    if (stationServices.includes("ruta_integrada")){
                        modal.querySelector(".info .group").innerHTML += `<div class="row">
                        <img src="https://metromapmed.s3.amazonaws.com/assets/img/icons/ruta_integrada.jpg" alt="Ruta Integrada">
                        <h6>Ruta Integrada</h6>
                        <span>/ integrated route</span>
                        </div>`
                    }
                    if (stationServices.includes("parqueadero_para_bicicletas")){
                        modal.querySelector(".info .group").innerHTML += `<div class="row">
                        <img src="https://metromapmed.s3.amazonaws.com/assets/img/icons/parqueadero_para_bicicletas.jpg" alt="parqueadero_para_bicicletas">
                        <h6>Parqueadero para Bicicletas</h6>
                        <span>/ Bicycle Parking</span>
                        </div>`
                    }
                    if (stationServices.includes("bibliometro")){
                        modal.querySelector(".info .group").innerHTML += `<div class="row">
                        <img src="https://metromapmed.s3.amazonaws.com/assets/img/icons/bibliometro.jpg" alt="bibliometro">
                        <h6>Bibliometro</h6>
                        <span>/ Library</span>
                        </div>`
                    }
                    if (stationServices.includes("sala_de_alfabetizacion_digital")){
                        modal.querySelector(".info .group").innerHTML += `<div class="row">
                        <img src="https://metromapmed.s3.amazonaws.com/assets/img/icons/sala_de_alfabetizacion_digital.jpg" alt="sala_de_alfabetizacion_digital">
                        <h6>Sala de Alfabetizacion Digital</h6>
                        <span>/ Digital Literasy Room</span>
                        </div>`
                    }
                    if (stationServices.includes("zona_wifi")){
                        modal.querySelector(".info .group").innerHTML += `<div class="row">
                        <img src="https://metromapmed.s3.amazonaws.com/assets/img/icons/zona_wifi.jpg" alt="zona_wifi">
                        <h6>Zona WIFI</h6>
                        <span>/ WiFi Zone</span>
                        </div>`
                    }
                    if (stationServices.includes("estacion_encicla")){
                        modal.querySelector(".info .group").innerHTML += `<div class="row">
                        <img src="https://metromapmed.s3.amazonaws.com/assets/img/icons/estacion_encicla.jpg" alt="estacion_encicla">
                        <h6>Estación EnCicla</h6>
                        <span>/ EnCicla Station</span>
                        </div>`
                    }
                }
                if (stationSitesOfInterest != "NULL"){
                    modal.querySelector(".info").innerHTML += `<div class="title">
                    <h4>Sitios de interés</h4>
                    <span> / Sites of interest</span>
                    </div>
                    <div class="group2"><div class="row"></div></div>`;
                    const sites = stationSitesOfInterest.replace(/[{}"]/g, "").split(",");
                    for (let i = 0; i < sites.length; i++){
                        modal.querySelector(".info .group2").innerHTML += `<div class="row">
                        <h6>${sites[i]}</h6>
                        </div>`
                    }
                }
                }
            })
            .catch(error => console.error(error));
    }

    modal.querySelector("button.close").addEventListener("click", () => {
        modal.classList.remove("active")
    })

    // Select station
    function selectStation(line, station) {
        const linea = document.querySelector(`.linea${line}stations`);
        var estacion = linea.querySelector(`.${station}.station`);
        return estacion;
    }

    // Select Segment
    function selectSegment(line, station1, station2){
        const linea = document.querySelector(`.linea${line}segments`);
        var segment = linea.querySelector(`.${station1}.${station2}`);
        if (segment == null){
            var segment = linea.querySelector(`.${station2}.${station1}`);
        }
        return segment
    }

    // alert(selectStation("O","facultad_de_minas"));
    /*
    setInterval(function minutero(line, station){
        const fechaActual = new Date();
        const fechaISO = fechaActual.toISOString();
        fetch(`http://embed.metromap.local:8000/request?uri=https://api.metromap.online/v1/incident/${line}/${station}/${fechaActual}`)
            .then(response => response.json())
            .then(data => {
                alert("Hola" + data)
            })
            .catch(error => console.error(error));
    }, 6000);
    */

    // Select all elements that have a class that constains the word "station"
    const stations = document.querySelectorAll('.station');

    // Add a "click" event to each element
    stations.forEach(station => {
        station.addEventListener("click", chigüiro);
    });

    // Select all buttons within a div with the class name "line_info"
    const btns = document.querySelectorAll("div.line_info button")

    // Get the SVG element with the ID "metromap_map"
    const svg = document.getElementById("metromap_map")

    // Get the div with the class name "line_info"
    const line_info = document.querySelector("div.line_info")

    // Add a click event listener to each button
    btns.forEach((btn) => {
        btn.addEventListener("click", (ev) => {
            button = ev.target
            if (button.dataset.line == undefined) {
                button = ev.target.parentNode
            }
            line = button.dataset.line
            // Check if the button is active
            if (btn.classList.contains("active")) {
                // If the button is active, unfocus the line

                // Get all lines that are currently focused
                const activebtns = document.querySelectorAll("div.line_info button.active")

                // If there are no more focused lines, focus all lines
                if (activebtns.length <= 1) {
                    svg.classList.remove("focus")
                    line_info.classList.remove("focus")
                    const unions = document.querySelectorAll(`svg#metromap_map g.unions g.linea${line}`)
                    unions.forEach((union) => {
                        union.classList.remove("focus")
                    })
                } else {
                    // If there are other lines in focus, check the unions
                    const actives = []
                    activebtns.forEach((temp) => {
                        actives.push("linea" + temp.dataset.line)
                    })
                    const unions = document.querySelectorAll(`svg#metromap_map g.unions g.linea${line}`)
                    unions.forEach((union) => {
                        let classArray = Array.from(union.classList);
                        let commonClasses = actives.filter(cls => classArray.includes(cls));
                        if (commonClasses.length <= 1) {
                            union.classList.remove("focus")
                        }
                    })

                }
                // Unfocus the line's segments and stations
                document.querySelector(`svg#metromap_map g.linea${line}segments`).classList.remove("focus")
                document.querySelector(`svg#metromap_map g.linea${line}stations`).classList.remove("focus")
                // Remove the "active" class from the button
                btn.classList.remove("active")
            } else {
                // If the button is not active, focus the line

                // Focus the entire map
                svg.classList.add("focus")
                line_info.classList.add("focus")
                // Focus the line's segments and stations
                document.querySelector(`svg#metromap_map g.linea${line}segments`).classList.add("focus")
                document.querySelector(`svg#metromap_map g.linea${line}stations`).classList.add("focus")
                // Focus the unions that have the same class as the line button
                const unions = document.querySelectorAll(`svg#metromap_map g.unions g.linea${line}`)
                unions.forEach((union) => {
                    union.classList.add("focus")
                })
                // Add the "active" class to the button
                btn.classList.add("active")
            }

        })
    })

    const pz = panzoom(svg, {
        minZoom: 1,
        maxZoom: 5,
        bounds: true,
        boundsPadding: 1,
        autocenter: true,
        zoomDoubleClickSpeed: 1
    })

    pz.on('zoom', function (e) {
        if (e.getTransform().scale > 1) {
            svg.classList.add("zoomed")
        } else {
            svg.classList.remove("zoomed")
        }
    });



</script>